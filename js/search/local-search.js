class LocalSearch{constructor({path:i="",unescape:s=!1,top_n_per_article:e=1}){this.path=i,this.unescape=s,this.top_n_per_article=e,this.isfetched=!1,this.datas=null}getIndexByWord(i,s,e=!1){const n=[],o=new Set;return e||(s=s.toLowerCase()),i.forEach(t=>{if(this.unescape){const d=document.createElement("div");d.innerText=t,t=d.innerHTML}const r=t.length;if(r===0)return;let c=0,h=-1;for(e||(t=t.toLowerCase());(h=s.indexOf(t,c))>-1;)n.push({position:h,word:t}),o.add(t),c=h+r}),n.sort((t,r)=>t.position!==r.position?t.position-r.position:r.word.length-t.word.length),[n,o]}mergeIntoSlice(i,s,e){let n=e[0],{position:o,word:t}=n;const r=[],c=new Set;for(;o+t.length<=s&&e.length!==0;){c.add(t),r.push({position:o,length:t.length});const h=o+t.length;for(e.shift();e.length!==0&&(n=e[0],o=n.position,t=n.word,h>o);)e.shift()}return{hits:r,start:i,end:s,count:c.size}}highlightKeyword(i,s){let e="",n=s.start;for(const{position:o,length:t}of s.hits)e+=i.substring(n,o),n=o+t,e+=`<mark class="search-keyword">${i.substr(o,t)}</mark>`;return e+=i.substring(n,s.end),e}getResultItems(i){const s=[];return this.datas.forEach(({title:e,content:n,url:o})=>{const[t,r]=this.getIndexByWord(i,e),[c,h]=this.getIndexByWord(i,n),d=new Set([...r,...h]).size,p=t.length+c.length;if(p===0)return;const f=[];t.length!==0&&f.push(this.mergeIntoSlice(0,e.length,t));let g=[];for(;c.length!==0;){const l=c[0],{position:m}=l,a=Math.max(0,m-20),w=Math.min(n.length,m+100);g.push(this.mergeIntoSlice(a,w,c))}g.sort((l,m)=>l.count!==m.count?m.count-l.count:l.hits.length!==m.hits.length?m.hits.length-l.hits.length:l.start-m.start);const C=parseInt(this.top_n_per_article,10);C>=0&&(g=g.slice(0,C));let u="";o=new URL(o,location.origin),o.searchParams.append("highlight",i.join(" ")),f.length!==0?u+=`<div class="local-search-hit-item"><a href="${o.href}"><span class="search-result-title">${this.highlightKeyword(e,f[0])}</span>`:u+=`<div class="local-search-hit-item"><a href="${o.href}"><span class="search-result-title">${e}</span>`,g.forEach(l=>{u+=`<p class="search-result">${this.highlightKeyword(n,l)}...</p></a>`}),u+="</div>",s.push({item:u,id:s.length,hitCount:p,includedCount:d})}),s}fetchData(){const i=!this.path.endsWith("json");fetch(this.path).then(s=>s.text()).then(s=>{this.isfetched=!0,this.datas=i?[...new DOMParser().parseFromString(s,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(s),this.datas=this.datas.filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e)),window.dispatchEvent(new Event("search:loaded"))})}highlightText(i,s,e){const n=i.nodeValue;let o=s.start;const t=[];for(const{position:r,length:c}of s.hits){const h=document.createTextNode(n.substring(o,r));o=r+c;const d=document.createElement("mark");d.className=e,d.appendChild(document.createTextNode(n.substr(r,c))),t.push(h,d)}i.nodeValue=n.substring(o,s.end),t.forEach(r=>{i.parentNode.insertBefore(r,i)})}highlightSearchWords(i){const s=new URL(location.href).searchParams.get("highlight"),e=s?s.split(" "):[];if(!e.length||!i)return;const n=document.createTreeWalker(i,NodeFilter.SHOW_TEXT,null),o=[];for(;n.nextNode();)n.currentNode.parentNode.matches("button, select, textarea, .mermaid")||o.push(n.currentNode);o.forEach(t=>{const[r]=this.getIndexByWord(e,t.nodeValue);if(!r.length)return;const c=this.mergeIntoSlice(0,t.nodeValue.length,r);this.highlightText(t,c,"search-keyword")})}}window.addEventListener("load",()=>{const{path:I,top_n_per_article:i,unescape:s,languages:e}=GLOBAL_CONFIG.localSearch,n=new LocalSearch({path:I,top_n_per_article:i,unescape:s}),o=document.querySelector("#local-search-input input"),t=document.getElementById("local-search-stats-wrap"),r=document.getElementById("loading-status"),c=!I.endsWith("json"),h=()=>{if(!n.isfetched)return;let a=o.value.trim().toLowerCase();c&&(a=a.replace(/</g,"&lt;").replace(/>/g,"&gt;")),a!==""&&(r.innerHTML='<i class="fas fa-spinner fa-pulse"></i>');const w=a.split(/[-\s]+/),E=document.getElementById("local-search-results");let x=[];if(a.length>0&&(x=n.getResultItems(w)),w.length===1&&w[0]==="")E.textContent="",t.textContent="";else if(x.length===0){E.textContent="";const S=document.createElement("div");S.className="search-result-stats",S.textContent=e.hits_empty.replace(/\$\{query}/,a),t.innerHTML=S.outerHTML}else{x.sort((y,v)=>y.includedCount!==v.includedCount?v.includedCount-y.includedCount:y.hitCount!==v.hitCount?v.hitCount-y.hitCount:v.id-y.id);const S=e.hits_stats.replace(/\$\{hits}/,x.length);E.innerHTML=`<div class="search-result-list">${x.map(y=>y.item).join("")}</div>`,t.innerHTML=`<hr><div class="search-result-stats">${S}</div>`,window.pjax&&window.pjax.refresh(E)}r.textContent=""};let d=!1;const p=document.getElementById("search-mask"),f=document.querySelector("#local-search .search-dialog"),g=()=>{window.innerWidth<768&&f.style.setProperty("--search-height",window.innerHeight+"px")},C=()=>{const a=document.body.style;a.width="100%",a.overflow="hidden",btf.animateIn(p,"to_show 0.5s"),btf.animateIn(f,"titleScale 0.5s"),setTimeout(()=>{o.focus()},300),d||(!n.isfetched&&n.fetchData(),o.addEventListener("input",h),d=!0),document.addEventListener("keydown",function w(E){E.code==="Escape"&&(u(),document.removeEventListener("keydown",w))}),g(),window.addEventListener("resize",g)},u=()=>{const a=document.body.style;a.width="",a.overflow="",btf.animateOut(f,"search_close .5s"),btf.animateOut(p,"to_hide 0.5s"),window.removeEventListener("resize",g)},l=()=>{btf.addEventListenerPjax(document.querySelector("#search-button > .search"),"click",C)},m=()=>{document.querySelector("#local-search .search-close-button").addEventListener("click",u),p.addEventListener("click",u),GLOBAL_CONFIG.localSearch.preload&&n.fetchData(),n.highlightSearchWords(document.getElementById("article-container"))};window.addEventListener("search:loaded",()=>{const a=document.getElementById("loading-database");a.nextElementSibling.style.display="block",a.remove()}),l(),m(),window.addEventListener("pjax:complete",()=>{!btf.isHidden(p)&&u(),n.highlightSearchWords(document.getElementById("article-container")),l()})});
